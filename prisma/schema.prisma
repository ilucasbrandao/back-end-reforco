generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model alunos {
  id                Int       @id @default(autoincrement())
  nome              String    @db.VarChar(255)
  data_nascimento   DateTime? @db.Date
  responsavel       String?   @db.VarChar(255)
  telefone          String?   @db.VarChar(20)
  data_matricula    DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Date
  serie             String?   @db.VarChar(50)
  observacao        String?
  status            String?   @default("ativo") @db.VarChar(10)
  criado_em         DateTime? @default(now()) @db.Timestamp(6)
  atualizado_em     DateTime? @default(now()) @db.Timestamp(6)
  turno             String?   @default("tarde") @db.VarChar(20)
  valor_mensalidade Decimal?  @default(150) @db.Decimal(10, 2)
  plano             String?   @default("padrao") @db.VarChar(20)
  foto_url          String?

  // Adicionado para suportar o fluxo de vencimento do Espa√ßo
  dia_vencimento    String?   @db.VarChar(2)

  fechamento_mensal   fechamento_mensal[]
  feedbacks           feedbacks[]
  receitas            receitas[]
  responsaveis_alunos responsaveis_alunos[]
}

model receitas {
  id_mensalidade Int       @id @default(autoincrement())
  id_aluno       Int
  valor          Decimal   @db.Decimal(10, 2)
  data_pagamento DateTime  @db.Date
  mes_referencia Int
  ano_referencia Int
  criado_em      DateTime? @default(now()) @db.Timestamp(6)
  atualizado_em  DateTime? @default(now()) @db.Timestamp(6)
  descricao      String?   @default("Mensalidade") @db.VarChar(255)
  
  // Relacionamento nomeado no singular para facilitar: receita.aluno.nome
  aluno          alunos    @relation(fields: [id_aluno], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model despesas {
  id_despesa     Int          @id @default(autoincrement())
  id_professor   Int?
  nome_professor String?      @db.VarChar(60)
  valor          Decimal      @db.Decimal(10, 2)
  data_pagamento DateTime     @db.Date
  mes_referencia Int
  ano_referencia Int
  categoria      String?      @default("Outros") @db.VarChar(50)
  criado_em      DateTime?    @default(now()) @db.Timestamp(6)
  atualizado_em  DateTime?    @default(now()) @db.Timestamp(6)
  descricao      String?      @default("Despesa geral") @db.VarChar(255)
  
  professor      professores? @relation(fields: [id_professor], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model feedbacks {
  id                  Int       @id @default(autoincrement())
  aluno_id            Int?
  autor_id            Int?
  data_aula           DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Date
  humor               String?   @db.VarChar(50)
  conteudo            String?
  observacao          String?
  lido_pelos_pais     Boolean?  @default(false)
  criado_em           DateTime? @default(now()) @db.Timestamp(6)
  bimestre            String?   @db.VarChar(50)
  avaliacao_pedagogica Json?     @default("{}")
  avaliacao_psico      Json?     @default("{}")
  fotos               Json?     @default("[]")
  
  aluno               alunos?   @relation(fields: [aluno_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  autor               users?    @relation(fields: [autor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model professores {
  id                Int                 @id @default(autoincrement())
  nome              String              @db.VarChar(255)
  data_nascimento   DateTime?           @db.Date
  telefone          String?             @db.VarChar(20)
  endereco          String?             @db.VarChar(255)
  data_contratacao  DateTime?           @db.Date
  nivel_ensino      String?             @db.VarChar(50)
  turno             String?             @db.VarChar(20)
  salario           Decimal?            @db.Decimal(10, 2)
  status            String?             @default("ativo") @db.VarChar(10)
  criado_em         DateTime?           @default(now()) @db.Timestamp(6)
  atualizado_em     DateTime?           @default(now()) @db.Timestamp(6)
  
  despesas          despesas[]
  fechamento_mensal fechamento_mensal[]
}

model fechamento_mensal {
  id_fechamento   Int          @id @default(autoincrement())
  ano             Int
  mes             Int
  saldo_final     Decimal      @db.Decimal(12, 2)
  id_professor    Int?
  nome_professor  String?      @db.VarChar(60)
  id_aluno        Int?
  nome_aluno      String?      @db.VarChar(60)
  usuario         String?      @db.VarChar(50)
  data_fechamento DateTime?    @default(now()) @db.Timestamp(6)
  
  aluno           alunos?      @relation(fields: [id_aluno], references: [id], onUpdate: NoAction)
  professor       professores? @relation(fields: [id_professor], references: [id], onUpdate: NoAction)

  @@unique([ano, mes])
}

model responsaveis_alunos {
  id             Int     @id @default(autoincrement())
  responsavel_id Int?
  aluno_id       Int?
  parentesco     String? @db.VarChar(50)
  
  aluno          alunos? @relation(fields: [aluno_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  responsavel    users?  @relation(fields: [responsavel_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model users {
  id                  Int                   @id @default(autoincrement())
  nome                String                @db.VarChar(100)
  email               String                @unique @db.VarChar(100)
  senha               String                @db.VarChar(255)
  role                String?               @default("responsavel") @db.VarChar(20)
  plano               String?               @default("basico") @db.VarChar(20)
  criado_em           DateTime?             @default(now()) @db.Timestamp(6)
  
  feedbacks           feedbacks[]
  responsaveis_alunos responsaveis_alunos[]
}